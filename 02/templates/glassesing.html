<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‹¤ì‹œê°„ ì•ˆê²½ ê°€ìƒ í”¼íŒ…</title>
  <style>
    #camera_view {
      position: relative;
      width: 640px;
      height: 480px;
    }

    video, canvas {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* ì…€ì¹´ì²˜ëŸ¼ ì¢Œìš° ë°˜ì „ */
    }
  </style>
</head>
<body>
  
  <h2>ğŸ˜ ì•ˆê²½ ê°€ìƒ í”¼íŒ…</h2>
  <div id="camera_view">
    <video id="videoElement" autoplay muted playsinline></video>
    <canvas id="overlayCanvas"></canvas>
  </div>

  <!-- FaceMesh CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('overlayCanvas');
    const ctx = canvas.getContext('2d');
    const glassesImg = new Image();

    glassesImg.onload = function () {
        const croppedCanvas = cropTransparentImage(glassesImg, 10);
        
      // í¬ë¡­ì´ë¯¸ì§€ë¡œ ë°˜í™˜ 
      const croppedImg = new Image();
      croppedImg.onload = function(){
        glassesImg.src = croppedImg.src;
      }
      
      croppedImg.src = croppedCanvas.toDataURL();

    };
    glassesImg.src = '../static/img/02.png'; // ì•ˆê²½ ì´ë¯¸ì§€
    

    const glassesTempleImg = new Image();
    glassesTempleImg.src = '../static/img/5.png'; // ì•ˆê²½ ë‹¤ë¦¬ ì´ë¯¸ì§€

    canvas.width = 640;
    canvas.height = 480;

    const faceMesh = new FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults(onResults);

    // function onResults(results) {
    //     ctx.clearRect(0, 0, canvas.width, canvas.height);

    //     if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            
    //         const landmarks = results.multiFaceLandmarks[0];

    //         // ëˆˆ ìœ„ì¹˜ (ì™¼/ì˜¤ë¥¸ìª½ ëˆˆê¼¬ë¦¬)
    //         const leftEye = landmarks[33];  // ì™¼ìª½ ëˆˆê¼¬ë¦¬
    //         const rightEye = landmarks[263]; // ì˜¤ë¥¸ìª½ ëˆˆê¼¬ë¦¬
    //         const eyeX = (leftEye.x + rightEye.x) / 2 * canvas.width;
    //         const eyeY = (leftEye.y + rightEye.y) / 2 * canvas.height;
    //         const dx = (rightEye.x - leftEye.x) * canvas.width;
    //         const dy = (rightEye.y - leftEye.y) * canvas.height;
    //         const angle = Math.atan2(dy, dx);
    //         const glassesWidth = Math.sqrt(dx * dx + dy * dy) * 1.5; // ëˆˆ ê°„ ê±°ë¦¬ x 2
    //         const aspectRatio = glassesImg.height / glassesImg.width;
    //         const glassesHeight = glassesWidth * aspectRatio;
    //         // í”„ë ˆì„ ê·¸ë¦¬ê¸°
    //         ctx.save();
    //         ctx.translate(eyeX, eyeY);
    //         ctx.rotate(angle);
    //         ctx.drawImage(glassesImg, -glassesWidth / 2, -glassesHeight / 2, glassesWidth, glassesHeight);
    //         ctx.restore();

    //         // ì–¼êµ´ íšŒì „ ê°ì§€ (yaw)
    //         const nose = landmarks[1];
    //         const leftCheek = landmarks[234];
    //         const rightCheek = landmarks[454];

    //         const leftX = leftCheek.x * canvas.width;
    //         const rightX = rightCheek.x * canvas.width;
    //         const noseX = nose.x * canvas.width;
    //         const faceCenterX = (leftX + rightX) / 2;
    //         const yaw = noseX - faceCenterX;

    //         // ì•ˆê²½ í”„ë ˆì„ ì™¼/ì˜¤ë¥¸ìª½ ëì  (í”„ë ˆì„ ì¤‘ì‹¬ + ë°©í–¥ * ì ˆë°˜ í­)
    //         const leftEndX = eyeX - Math.cos(angle) * (glassesWidth / 2);
    //         const leftEndY = eyeY - Math.sin(angle) * (glassesWidth / 2);
    //         const rightEndX = eyeX + Math.cos(angle) * (glassesWidth / 2);
    //         const rightEndY = eyeY + Math.sin(angle) * (glassesWidth / 2);

    //         // ê·€ ì¢Œí‘œ
    //         const leftEar = landmarks[127];
    //         const rightEar = landmarks[356];
    //         const leftEarX = leftEar.x * canvas.width;
    //         const leftEarY = leftEar.y * canvas.height;
    //         const rightEarX = rightEar.x * canvas.width;
    //         const rightEarY = rightEar.y * canvas.height;

            
    //         // íšŒì „ ë°©í–¥ì— ë”°ë¼ ì•ˆê²½ ë‹¤ë¦¬ ë¶™ì´ê¸°
    //         if (yaw > 15) {
    //             // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ëŒë¦° ê²½ìš° â†’ ì™¼ìª½ ë‹¤ë¦¬ë§Œ
    //             const dx = leftEarX - leftEndX;
    //             const dy = leftEarY - leftEndY;
    //             const angleToEar = Math.atan2(dy, dx);
    //             const length = Math.sqrt(dx * dx + dy * dy);
    //             const height = length * (glassesTempleImg.height / glassesTempleImg.width);

    //             ctx.save();
    //             ctx.translate(leftEndX, leftEndY);
    //             ctx.rotate(angleToEar);
    //             ctx.drawImage(glassesTempleImg, 0, -height / 2, length*1.5, height);
    //             ctx.restore();

    //         } else if (yaw < -15) {
    //             // ì™¼ìª½ìœ¼ë¡œ ëŒë¦° ê²½ìš° â†’ ì˜¤ë¥¸ìª½ ë‹¤ë¦¬ë§Œ
    //             const dx = rightEarX - rightEndX;
    //             const dy = rightEarY - rightEndY;
    //             const angleToEar = Math.atan2(dy, dx);
    //             const length = Math.sqrt(dx * dx + dy * dy);
    //             const height = length * (glassesTempleImg.height / glassesTempleImg.width);

    //             ctx.save();
    //             ctx.translate(rightEndX, rightEndY);
    //             ctx.rotate(angleToEar);
    //             ctx.drawImage(glassesTempleImg, 0, -height / 2, length*1.5, height);
    //             ctx.restore();
    //         }
    //     }
    // }


    // ê°ë„ë³„ ì•ˆê²½ì•Œ ë¹„ìœ¨ë° ìœ„ì¹˜ ìì—°ìŠ¤ëŸ½ê²Œ
    
    
    function onResults(results) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!(results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0)) return;

      const landmarks = results.multiFaceLandmarks[0];
      const leftEye = landmarks[33];
      const rightEye = landmarks[263];
      const eyeX = (leftEye.x + rightEye.x) / 2 * canvas.width;
      const eyeY = (leftEye.y + rightEye.y) / 2 * canvas.height;

      const dx = (rightEye.x - leftEye.x) * canvas.width;
      const dy = (rightEye.y - leftEye.y) * canvas.height;
      const angle = Math.atan2(dy, dx);
      const glassesWidth = Math.sqrt(dx * dx + dy * dy) * 1.5;
      const aspectRatio = glassesImg.height / glassesImg.width;
      const glassesHeight = glassesWidth * aspectRatio;

      // yaw ê³„ì‚°
      const noseX = landmarks[1].x * canvas.width;
      const faceCenterX = ((landmarks[234].x + landmarks[454].x) / 2) * canvas.width;
      const yaw = (noseX - faceCenterX) / canvas.width;

      // ì¢Œìš° ë¹„ìœ¨ ì¡°ì •
      let yawRatio = (noseX - faceCenterX) / canvas.width;  // ì „ì²´ í™”ë©´ ê¸°ì¤€ìœ¼ë¡œ ì •ê·œí™” (ì•½ -0.1 ~ 0.1 ì •ë„)
      let leftRatio = 1 + yawRatio * 2.5;
      let rightRatio = 1 - yawRatio * 2.5;
      leftRatio = Math.max(0.8, Math.min(1.2, leftRatio));
      rightRatio = Math.max(0.8, Math.min(1.2, rightRatio));

      // ì•ˆê²½ ë Œì¦ˆ ë‚˜ëˆ ì„œ ê·¸ë¦¬ê¸° (ê¸°ì¤€ì€ ì˜¤ë¥¸ìª½ ë)
      ctx.save();
      ctx.translate(eyeX, eyeY);
      ctx.rotate(angle);

      const halfSrcW = glassesImg.width / 2;
      const halfDstW = glassesWidth / 2;
      const height = glassesHeight;
      const downY = 8;
      // ì™¼ìª½
      ctx.drawImage(
        glassesImg,
        0, 0, halfSrcW, glassesImg.height,
        -halfDstW, -height / 2 +downY,
        halfDstW * leftRatio, height
      );

      // ì˜¤ë¥¸ìª½
      ctx.drawImage(
        glassesImg,
        halfSrcW, 0, halfSrcW, glassesImg.height,
        halfDstW - halfDstW * rightRatio, -height / 2 +downY,
        halfDstW * rightRatio, height
      );
      ctx.restore();


      // ì•ˆê²½ë‹¤ë¦¬ ~
      // ê·€ ì¢Œí‘œ
      const leftEar = landmarks[127];
      const rightEar = landmarks[356];
      const leftEarX = leftEar.x * canvas.width;
      const leftEarY = leftEar.y * canvas.height;
      const rightEarX = rightEar.x * canvas.width;
      const rightEarY = rightEar.y * canvas.height;

      // í”„ë ˆì„ì˜ ì–‘ ëì 
      const leftEndX = eyeX - halfDstW;
      const leftEndY = eyeY - Math.sin(angle) * (halfDstW * leftRatio);
      const rightEndX = eyeX + halfDstW;
      const rightEndY = eyeY + Math.sin(angle) * (halfDstW * rightRatio);

      // ë‹¤ë¦¬ ë¶™ì´ê¸°
      if (yaw > 0.02) {
        // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê³ ê°œ ëŒë¦¼ â†’ ì™¼ìª½ ë‹¤ë¦¬ ë¶™ì´ê¸°
        const dx = leftEarX - leftEndX;
        const dy = leftEarY - leftEndY;
        const angleToEar = Math.atan2(dy, dx);
        const length = Math.sqrt(dx * dx + dy * dy);
        const templeHeight = length * (glassesTempleImg.height / glassesTempleImg.width);

        ctx.save();
        ctx.translate(leftEndX, leftEndY);
        ctx.rotate(angleToEar);
        ctx.drawImage(glassesTempleImg, 0, -templeHeight / 2, length * 1.5, templeHeight);
        ctx.restore();
      } else if (yaw < -0.02) {
        // ì™¼ìª½ìœ¼ë¡œ ê³ ê°œ ëŒë¦¼ â†’ ì˜¤ë¥¸ìª½ ë‹¤ë¦¬ ë¶™ì´ê¸°
        const dx = rightEarX - rightEndX;
        const dy = rightEarY - rightEndY;
        const angleToEar = Math.atan2(dy, dx);
        const length = Math.sqrt(dx * dx + dy * dy);
        const templeHeight = length * (glassesTempleImg.height / glassesTempleImg.width);

        ctx.save();
        ctx.translate(rightEndX, rightEndY);
        ctx.rotate(angleToEar);
        ctx.drawImage(glassesTempleImg, 0, -templeHeight / 2, length * 1.5, templeHeight);
        ctx.restore();
      }
     
    }



    const camera = new Camera(video, {
      onFrame: async () => {
        await faceMesh.send({ image: video });
      },
      width: 640,
      height: 480
    });

    camera.start();

    // ì´ë¯¸ì§€ ê³µë°± í¬ë¡­ 
  function cropTransparentImage(image, padding = 50) {
      const cropCanvas = document.createElement("canvas");
      const ctx = cropCanvas.getContext("2d");

      cropCanvas.width = image.width;
      cropCanvas.height = image.height;

      ctx.drawImage(image, 0, 0);

      const imageData = ctx.getImageData(0, 0, cropCanvas.width, cropCanvas.height);
      const data = imageData.data;

      let minX = cropCanvas.width, minY = cropCanvas.height;
      let maxX = 0, maxY = 0;

      for (let y = 0; y < cropCanvas.height; y++) {
          for (let x = 0; x < cropCanvas.width; x++) {
              const idx = (y * cropCanvas.width + x) * 4;
              const alpha = data[idx + 3]; // alpha ê°’

              if (alpha > 0) {
                  if (x < minX) minX = x;
                  if (x > maxX) maxX = x;
                  if (y < minY) minY = y;
                  if (y > maxY) maxY = y;
              }
          }
      }

      // íŒ¨ë”© ì ìš©
      minX = Math.max(0, minX - padding);
      minY = Math.max(0, minY - padding);
      maxX = Math.min(cropCanvas.width, maxX + padding);
      maxY = Math.min(cropCanvas.height, maxY + padding);

      const croppedWidth = maxX - minX;
      const croppedHeight = maxY - minY;

      // ìƒˆ ìº”ë²„ìŠ¤ì— í¬ë¡­ëœ ì˜ì—­ ë³µì‚¬
      const croppedCanvas = document.createElement("canvas");
      croppedCanvas.width = croppedWidth;
      croppedCanvas.height = croppedHeight;

      const croppedCtx = croppedCanvas.getContext("2d");
      croppedCtx.drawImage(cropCanvas, minX, minY, croppedWidth, croppedHeight, 0, 0, croppedWidth, croppedHeight);

      // ê²°ê³¼ ë°˜í™˜ (base64 ë˜ëŠ” croppedCanvas ì‚¬ìš© ê°€ëŠ¥)
      return croppedCanvas;
  }




    
  </script>
</body>
</html>
