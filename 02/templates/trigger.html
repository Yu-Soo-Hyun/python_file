<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <link rel="stylesheet" type="text/css" href="../static/css/chat.css">
    <style>
        body { text-align: center; }
        video { width: 600px; height: 400px; border: 2px solid black;box-sizing: none; }
        canvas { position: absolute; width: 600px;height: 400px; left: 50%; transform: translateX(-50%); }
        .btn-container { position: absolute; top: 500px; left: 50%;  transform: translateX(-50%);}
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
    <title>íŠ¸ë¦¬ê±° ë²„íŠ¼</title>
</head>
<body>
    <div id="out_box">
        <!-- í—¤ë“œ(ë„¤ë¹„ë¹„) -->
        <div id="nav_box">
            <h1><a href="/">Glasses For You</a></h1>
            <div>
                <li><a href="/info">ì†Œê°œ</a></li>
                <li><a href="/chat">ì•ˆê²½ì¶”ì²œ</a></li>
                <li><a href="/context">context us</a></li>
            </div>
        </div>

        <!-- ë©”ì¸ -->
        <video id="videoElement" autoplay></video>
        <canvas id="outputCanvas"></canvas> 
    
        <div class="btn-container">
            
            <p id="status">ìƒíƒœ: ì¹´ë©”ë¼ off </p>
            <button id="startCam">ìº  ì¼œê¸°</button>
            <button id="screenShot">ì‚¬ì§„ì´¬ì˜</button>
            <button id="stopCam">ìº  ë„ê¸°</button>
            <button id="clearCanvas">ì´ˆê¸°í™”</button>
        </div>
    
    </div>
</body>

<script>

let video = document.getElementById("videoElement");
let canvas = document.getElementById("outputCanvas");
let ctx = canvas.getContext("2d");
let statusText = document.getElementById("status");

let countdown = 3; // ì´ˆê¸° ì¹´ìš´íŠ¸ë‹¤ìš´ ê°’
let countdownInterval = null; // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¸í„°ë²Œ ë³€ìˆ˜
let isCounting = false; // í˜„ì¬ ì¹´ìš´íŠ¸ë‹¤ìš´ ì§„í–‰ ì¤‘ì¸ì§€ ì—¬ë¶€
let isLookingStraight = false; // ì‚¬ìš©ìê°€ ì •ë©´ì„ ë³´ê³  ìˆëŠ”ì§€ ì—¬ë¶€

// ìº í‚¤ê¸° í´ë¦­
$('#startCam').on('click', function(){
    clearCanvas();
    setupCamera();
});

// ìº  ë„ê¸° í´ë¦­
$('#stopCam').on('click', function(){
    stopCamera();
});


// ì‚¬ì§„ì´¬ì˜ í´ë¦­
$('#screenShot').on('click', function(){
    // console.log('ëˆŒëŸ¬ì§€ëƒ?');
    // rotationFace();
    // captureFace();
    if (!isCounting) {
        rotationFace();
    }
});

// ìº”ë²„ìŠ¤ ë‚ ë¦¬ê¸° 
$('#clearCanvas').on('click', function(){
    clearCanvas();
});


// ì¹´ë©”ë¼ on 
async function setupCamera() {
    try{

        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 600, height: 400 }
        });
        videoStream = stream;
        video.srcObject = stream;
        statusText.textContent = "ì¹´ë©”ë¼ on";
        return new Promise(resolve => video.onloadedmetadata = resolve);
    } catch (error) {
        console.error("ì›¹ìº  ì ‘ê·¼ ì‹¤íŒ¨:", error);
    }
}

// ì •ë©´ íƒì§€
function rotationFace(){
    if (videoStream) {
        const faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });
        
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: false, 
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5,
        });

        faceMesh.onResults(direction);

        async function detect() {
            await faceMesh.send({ image: video });
            requestAnimationFrame(detect);
        }

        detect();
    }

}

// ë°©í–¥ì²´í¬
function direction(results){
    if (results.multiFaceLandmarks) {
        for (const landmarks of results.multiFaceLandmarks) {
            let noseTip = landmarks[4];  // ì½” ë
            let leftEyeOuter = landmarks[33];  // ì™¼ìª½ ëˆˆê¼¬ë¦¬
            let rightEyeOuter = landmarks[263];  // ì˜¤ë¥¸ìª½ ëˆˆê¼¬ë¦¬
            let leftMouthCorner = landmarks[61];  // ì™¼ìª½ ì…ê¼¬ë¦¬
            let rightMouthCorner = landmarks[291];  // ì˜¤ë¥¸ìª½ ì…ê¼¬ë¦¬

            // ì •ë©´ ì—¬ë¶€ íŒë‹¨
            let faceCenterX = (leftEyeOuter.x + rightEyeOuter.x) / 2; // ëˆˆ ì¤‘ì‹¬
            let noseX = noseTip.x;  // ì½” ìœ„ì¹˜

            let eyeDiff = Math.abs(leftEyeOuter.y - rightEyeOuter.y);
            let mouthDiff = Math.abs(leftMouthCorner.y - rightMouthCorner.y);

            if (Math.abs(faceCenterX - noseX) < 0.02 && eyeDiff < 0.02 && mouthDiff < 0.02) {
                statusText.textContent = "âœ… ì •ë©´ì„ ë³´ê³  ìˆìŒ";
                isLookingStraight = true;
                if (!isCounting) {
                    startCountdown(); // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                }
            } else {
                statusText.textContent = "âŒ ê³ ê°œê°€ ê¸°ìš¸ì–´ì§";
                isLookingStraight = false;
                stopCountdown(); // ì¹´ìš´íŠ¸ë‹¤ìš´ ë©ˆì¶¤
            }

            //ëœë“œë§ˆí¬ ì  ì°ê¸°(ì„ì‹œ)
            // drawLandmark(noseTip, "yellow");
            // drawLandmark(leftEyeOuter, "blue");
            // drawLandmark(rightEyeOuter, "blue");
            // drawLandmark(leftMouthCorner, "red");
            // drawLandmark(rightMouthCorner, "red");
        }
    } else {
        statusText.textContent = "âš  ì–¼êµ´ ê°ì§€ ì‹¤íŒ¨";
        statusText.style.color = "gray";
        isLookingStraight = false;
        stopCountdown();
    }
}

// ëœë“œë§ˆí¬í‘œì‹œ (ì„ì‹œ)
// function drawLandmark(point, color) {
//     ctx.fillStyle = color;
//     ctx.beginPath();
//     ctx.arc(point.x * canvas.width, point.y * canvas.height, 3, 0, 2 * Math.PI);
//     ctx.fill();
// }

// ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
function startCountdown() {
    if (countdownInterval) return; // ì´ë¯¸ ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

    isCounting = true;
    let countdownDisplay = document.createElement("p");
    countdownDisplay.id = "countdownText";
    countdownDisplay.style.fontSize = "30px";
    countdownDisplay.style.color = "blue";
    countdownDisplay.style.position = "absolute";
    countdownDisplay.style.top = "10px";
    countdownDisplay.style.left = "50%";
    countdownDisplay.style.transform = "translateX(-50%)";
    document.body.appendChild(countdownDisplay);

    countdown = 3;
    countdownInterval = setInterval(() => {
        if (!isLookingStraight) {
            stopCountdown();
            return;
        }

        countdownDisplay.textContent = `ğŸ“¸ ${countdown}`;
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            countdownInterval = null;
            document.body.removeChild(countdownDisplay);
            captureFace(); // ìº¡ì²˜ ì‹¤í–‰
            isCounting = false;
        } else {
            countdown--;
        }
    }, 1000);
}

// ì¹´ìš´íŠ¸ë‹¤ìš´ ë©ˆì¶¤
function stopCountdown() {
    if (countdownInterval) {
        $('#countdownText').remove();
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    isCounting = false;
}

// ìº¡ì³ ì‹œì‘
function captureFace() {
    if (!videoStream) {
        console.error("ìº ì´ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤.");
        return;
    }
    
    let captureCanvas = canvas
    // let captureCanvas = document.createElement("canvas");
    captureCanvas.width = video.videoWidth;
    captureCanvas.height = video.videoHeight;
    let captureCtx = captureCanvas.getContext("2d");

    captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);

    // ìº¡ì²˜ëœ ì´ë¯¸ì§€ ë°ì´í„° (Base64 PNG)
    let imageDataURL = captureCanvas.toDataURL("image/png");
    console.log("ìº¡ì²˜ëœ ì´ë¯¸ì§€ ë°ì´í„°:", imageDataURL);
    stopCamera(); //ë°˜ë³µ x

    return imageDataURL;
}


// ì¹´ë©”ë¼ off
function stopCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop()); // ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
        video.srcObject = null;
        videoStream = null;
        statusText.textContent = "ì¹´ë©”ë¼ off";
        console.log("ì¹´ë©”ë¼ ì¢…ë£Œë¨");
    }
}

// ìº”ë²„ìŠ¤ ì´ˆê¸°í™” 
function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}



</script>
</html>